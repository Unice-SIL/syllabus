{% extends 'base_layout.html.twig' %}
{% block navbar %}
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <h3>{{ courseInfo.title }}</h3>
        </li>
    </ul>
{% endblock %}

{% block sidebar %}
    <div class="sidebar">
        <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                <li class="nav-item has-treeview">
                    <a class="nav-link menu-tab"
                       href="{{ path('course_presentation', { 'id': courseInfo.id }) }}"
                       id="menu-presentation">
                        <i>1</i>&nbsp;
                        <p>Présentation générale</p>
                    </a>
                </li>
                <li class="nav-item has-treeview">
                    <a class="nav-link menu-tab"
                       id="menu-activities"
                       href="{{ path('edit_activities_course_info', { 'id': courseInfo.id }) }}">
                        <i>2</i>&nbsp;
                        <p>Contenu et activités</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu-tab" id="menu-objective"
                       href="{{ path('edit_objectives_course_info', { 'id': courseInfo.id }) }}">
                        <i>3</i>&nbsp;
                        <p>Objectifs du cours</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu-tab"
                       id="menu-evaluation"
                       href="{{ path('course_evaluation', { 'id': courseInfo.id }) }}">
                        <i>4</i>&nbsp;
                        <p>Modalités d'évaluation</p>
                    </a>
                </li>
                <li class="nav-item menu-tab">
                    <a class="nav-link" href="{{ path('edit_equipments_course_info', { 'id': courseInfo.id }) }}">
                        <i>5</i>&nbsp;
                        <p>Matériel et ressources</p>
                    </a>
                </li>
                <li class="nav-item menu-tab">
                    <a class="nav-link" href="{{ path('course_info_info', { 'id': courseInfo.id }) }}"
                       id="menu-info">
                        <i>6</i>&nbsp;
                        <p>Informations pratiques</p>
                    </a>
                </li>
                <li class="nav-item menu-tab">
                    <a class="nav-link" href="{{ path('course_closing_remarks', { 'id': courseInfo.id }) }}"
                       id="menu-closing_remarks">
                        <i>7</i>&nbsp;
                        <p>Le mot de la fin</p>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
{% endblock %}
{% block content %}
    <div class="container-fluid pt-2">
        {% block subContent %}{% endblock %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function () {
            $('.card-syllabus').each( function () {
                let $card = $(this);
                let $cardBody = $card.find('.card-body');
                let url = $card.data('view-url');
                $.get(url, {
                    beforeSend: function () {
                        $cardBody.html('<div class="progress mx-auto" style="max-width: 95%"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div>')
                    }
                }).done(function (response) {
                    if (Syllabus.handleAjaxResponseModal(response))
                    {
                        $cardBody.html(response["content"]);
                    }
                })
            });

            $(document).on('click', '.card-syllabus .edit-button', function () {
                let $button = $(this);
                let $card = $button.closest('.card-syllabus');
                let $cardBody = $card.find('.card-body');
                let url = $card.data("form-url");
                $.get(url, {
                    beforeSend: function () {
                        $button.hide();
                        $cardBody.html('<div class="progress mx-auto" style="max-width: 95%"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div>')
                    }
                }).done(function (response) {
                    if (Syllabus.handleAjaxResponseModal(response))
                    {
                        $cardBody.html(response["content"]);
                    }
                })
            });

            $(document).on('click', '.card-syllabus .submit-button', function () {
                let $button = $(this);
                let $card = $button.closest('.card-syllabus');
                let $cardBody = $card.find('.card-body');
                let $editButton = $card.find('.edit-button');
                let forms = $card.find('form');
                let url = $card.data('form-url');
                $.ajax({
                    url: url,
                    enctype: 'multipart/form-data',
                    processData: false, // Preventing default serialization.
                    contentType: false, // No auto “contentType” header.
                    data: new FormData( forms[0] ),
                    method: "POST",
                    dataType: "json",
                }).done(function (response) {
                    $cardBody.html(response["content"]);
                    $editButton.show();
                });
            });

            $(document).on('click', '.card-syllabus .cancel-button', function () {
                let $button = $(this);
                let $card = $button.closest('.card-syllabus');
                let $cardBody = $card.find('.card-body');
                let $editButton = $card.find('.edit-button');
                let url = $card.data('view-url');
                $.get(url, {
                    beforeSend: function () {
                        $cardBody.html('<div class="progress mx-auto" style="max-width: 95%"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div>')
                    }
                }).done(function (response) {
                    if (Syllabus.handleAjaxResponseModal(response))
                    {
                        $cardBody.html(response["content"]);
                    }
                }).always(function () {
                    $editButton.show();
                })
            });

            $(document).on('submit', 'form', function (e) {
                e.preventDefault();
                formSubmit($(this), 'submit');
            });
            $(document).on('click', '.focus-cancel', function () {
                formSubmit($(this), 'cancel');
            });
        });

        function formSubmit(element, action)
        {
            let card = element.closest('.toggle-focus');
            let section = card.parent('section');
            let forms = card.find('form');
            let focusSubmit = card.find('button.focus-submit');
            let focusSubmitContent = focusSubmit.html();
            let focusCancel = card.find('button.focus-cancel');
            let focusCancelContent = focusCancel.html();

            let buttonClicked = action === 'cancel' ? focusCancel : focusSubmit;
            let url = buttonClicked.data("url");
            $.ajax({
                url: url,
                enctype: 'multipart/form-data',
                processData: false, // Preventing default serialization.
                contentType: false, // No auto “contentType” header.
                data: new FormData( forms[0] ),
                method: "POST",
                dataType: "html",
                beforeSend: function () {
                    focusSubmit.attr("disabled", true);
                    focusCancel.attr("disabled", true);
                    buttonClicked.html('<i class="fas fa-spinner fa-spin"></i>');
                },
                success: function (data) {
                    $('#app').removeClass('hasActiveChild');
                    $(card).removeClass('active');
                    section.html(data);
                }
            }).always( function () {
                focusSubmit.attr("disabled", false).html(focusSubmitContent);
                focusCancel.attr("disabled", false).html(focusCancelContent);
            });
        }
    </script>
{% endblock %}